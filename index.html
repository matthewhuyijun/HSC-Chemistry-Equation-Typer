<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<title>HSC Chemistry ‚Äì Equation Typer (with Isotopes)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  color-scheme: light;
  --bg: #f8fafc;
  --card: #ffffff;
  --ink: #111827;
  --muted: #6b7280;
  --brand: #2563eb;
  --brand-ink: #ffffff;
  --border: #e2e8f0;
  --key-bg: rgba(255, 255, 255, 0.9);
  --copy-bg: #ffffff;
  --copy-border: rgba(15, 23, 42, 0.15);
  --copy-ink: #0f172a;
  --copy-hover-bg: var(--brand);
  --copy-hover-ink: var(--brand-ink);
  --copy-hover-border: rgba(37, 99, 235, 0.65);
  --color-header-bg: var(--brand);
  --color-header-text: var(--brand-ink);
  --color-surface: var(--card);
  --color-border: var(--border);
  --color-tab-active-bg: var(--brand);
  --color-tab-active-text: var(--brand-ink);
  --wallpaper-light: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'><rect width='100%' height='100%' fill='none'/><circle cx='14' cy='14' r='0.75' fill='%23cbd5e1' opacity='0.55'/></svg>");
  --wallpaper-dark: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'><rect width='100%' height='100%' fill='none'/><circle cx='14' cy='14' r='0.75' fill='%23334155' opacity='0.55'/></svg>");
  --wallpaper: var(--wallpaper-light);
  --scale: 1.1;
}
[data-theme="dark"] {
  color-scheme: dark;
  --bg: #0f172a;
  --card: #1e293b;
  --ink: #e2e8f0;
  --muted: #94a3b8;
  --brand: #1d4ed8;
  --brand-ink: #f8fafc;
  --border: #334155;
  --key-bg: rgba(30, 41, 59, 0.9);
  --copy-bg: rgba(15, 23, 42, 0.85);
  --copy-border: rgba(148, 163, 184, 0.45);
  --copy-ink: #f8fafc;
  --copy-hover-bg: var(--brand);
  --copy-hover-ink: var(--brand-ink);
  --copy-hover-border: rgba(37, 99, 235, 0.65);
  --color-header-bg: var(--brand);
  --color-header-text: var(--brand-ink);
  --color-surface: var(--card);
  --color-border: var(--border);
  --color-tab-active-bg: var(--brand);
  --color-tab-active-text: var(--brand-ink);
  --wallpaper: var(--wallpaper-dark);
}
* {
  box-sizing: border-box;
}
html, body { overflow: hidden; overscroll-behavior: none; touch-action: pan-y; }
body {
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
  margin: 0;
  background: var(--bg);
  color: var(--ink);
  transition: background 0.3s ease, color 0.3s ease;
  font-size: calc(16px * var(--scale));
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: calc(12px * var(--scale));
  padding: calc(12px * var(--scale)) calc(16px * var(--scale));
  background: var(--brand);
}
header h1 {
  font-size: calc(18px * var(--scale));
  margin: 0;
  font-weight: 600;
  color: var(--brand-ink);
}
header .header-left {
  display: flex;
  align-items: center;
  gap: calc(12px * var(--scale));
  flex-wrap: wrap;
}
.header-actions {
  display: flex;
  gap: calc(12px * var(--scale));
  flex-wrap: wrap;
}
.header-controls {
  display: flex;
  align-items: center;
  gap: calc(16px * var(--scale));
}
#status {
  font-size: calc(14px * var(--scale));
  font-weight: 600;
  opacity: 0.95;
  color: var(--brand-ink);
}
.theme-switcher {
  display: flex;
  align-items: center;
  gap: calc(6px * var(--scale));
  font-size: calc(14px * var(--scale));
  font-weight: 600;
  color: var(--brand-ink);
}
.visually-hidden {
  position: absolute !important;
  height: 1px;
  width: 1px;
  overflow: hidden;
  clip: rect(1px, 1px, 1px, 1px);
  white-space: nowrap;
  border: 0;
  padding: 0;
  margin: -1px;
}
.theme-segmented {
  display: inline-flex;
  align-items: center;
  gap: calc(4px * var(--scale));
  padding: calc(6px * var(--scale));
  border-radius: calc(16px * var(--scale));
  background: rgba(17, 30, 55, 0.92);
  border: 1px solid rgba(108, 124, 168, 0.45);
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.15);
}
[data-theme="light"] .theme-segmented {
  background: rgba(22, 36, 66, 0.9);
  border-color: rgba(75, 102, 152, 0.5);
}
[data-theme="dark"] .theme-segmented {
  background: rgba(12, 24, 50, 0.92);
  border-color: rgba(99, 135, 189, 0.4);
}
.theme-segmented input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}
.theme-segmented label {
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: calc(36px * var(--scale));
  height: calc(30px * var(--scale));
  padding: 0 calc(12px * var(--scale));
  border-radius: calc(10px * var(--scale));
  font-size: calc(16px * var(--scale));
  color: rgba(226, 232, 240, 0.7);
  transition: background 0.18s ease, color 0.18s ease, opacity 0.18s ease, box-shadow 0.18s ease;
}
.theme-segmented label:hover {
  color: rgba(248, 250, 252, 0.9);
}
.theme-segmented input:checked + label {
  background: linear-gradient(145deg, rgba(90, 110, 152, 0.9), rgba(63, 81, 122, 0.95));
  color: #f8fafc;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.2), 0 0 0 1px rgba(146, 174, 220, 0.55);
}
.theme-segmented label:focus-visible {
  outline: calc(2px * var(--scale)) solid rgba(37, 99, 235, 0.6);
  outline-offset: calc(2px * var(--scale));
}
main {
  width: min(calc(960px * var(--scale)), 90vw);
  margin: calc(18px * var(--scale)) auto;
  padding: 0 calc(12px * var(--scale)) calc(24px * var(--scale));
  display: grid;
  gap: calc(12px * var(--scale));
}
.panel,
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: calc(12px * var(--scale));
  overflow: hidden;
  box-shadow: 0 1px 1px rgba(15, 23, 42, 0.06);
}
.panel .head {
  padding: calc(10px * var(--scale)) calc(12px * var(--scale));
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  display: flex;
  justify-content: center;
  align-items: center;
  color: var(--ink);
  text-align: center;
}
.panel .body,
.card .body {
  padding: calc(12px * var(--scale));
}
math-field,
textarea {
  font-size: calc(18px * var(--scale));
  padding: calc(10px * var(--scale));
  border: 1px solid var(--border);
  border-radius: calc(10px * var(--scale));
  background: var(--card);
  color: var(--ink);
  width: 100%;
  transition: border-color 0.2s ease, background 0.2s ease;
}
math-field {
  min-height: calc(52px * var(--scale));
}
textarea {
  min-height: calc(52px * var(--scale));
  resize: none;
}
#ta {
  min-height: calc(52px * var(--scale));
}
.preview-card .body {
  padding: 0;
}
#preview {
  min-height: calc(52px * var(--scale));
  padding: calc(16px * var(--scale));
}
.row {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: calc(10px * var(--scale));
  align-items: center;
}
.btn {
  padding: calc(4px * var(--scale)) calc(8px * var(--scale));
  border: 1px solid var(--border);
  border-radius: calc(6px * var(--scale));
  background: var(--card);
  cursor: pointer;
  font-size: calc(12px * var(--scale));
  color: var(--ink);
}
.btn:active {
  transform: translateY(calc(1px * var(--scale)));
}
.btn:focus-visible {
  outline: calc(2px * var(--scale)) solid var(--brand);
  outline-offset: calc(2px * var(--scale));
}
.btn:hover,
.btn:focus-visible {
  background: var(--copy-hover-bg);
  border-color: var(--copy-hover-border);
  color: var(--copy-hover-ink);
}
.copyBtn,
.header-copy {
  appearance: none;
  align-items: center;
  justify-content: center;
  display: inline-flex;
  gap: calc(6px * var(--scale));
  padding: calc(8px * var(--scale)) calc(18px * var(--scale));
  border-radius: calc(999px * var(--scale));
  border: 1px solid var(--copy-border);
  background: var(--copy-bg);
  color: var(--copy-ink);
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  letter-spacing: -0.01em;
  box-shadow: 0 calc(6px * var(--scale)) calc(18px * var(--scale)) rgba(15, 23, 42, 0.25);
  transition: background 0.18s ease, color 0.18s ease, box-shadow 0.18s ease, transform 0.12s ease, border-color 0.18s ease;
}
.copyBtn {
  font-size: calc(12px * var(--scale));
}
.header-copy {
  font-size: calc(14px * var(--scale));
}
.copyBtn:hover,
.header-copy:hover,
.copyBtn:focus-visible,
.header-copy:focus-visible {
  background: color-mix(in srgb, var(--brand) 25%, var(--copy-bg));
  border-color: var(--brand);
  box-shadow: 0 calc(4px * var(--scale)) calc(14px * var(--scale)) rgba(37, 99, 235, 0.25);
  transform: translateY(calc(-1px * var(--scale)));
}
.copyBtn:focus-visible,
.header-copy:focus-visible {
  outline: calc(2px * var(--scale)) solid rgba(37, 99, 235, 0.6);
  outline-offset: calc(2px * var(--scale));
}
.copyBtn:active,
.header-copy:active {
  box-shadow: 0 calc(2px * var(--scale)) calc(8px * var(--scale)) rgba(15, 23, 42, 0.25);
}
#keyboard {
  display: flex;
  flex-wrap: wrap;
  gap: calc(8px * var(--scale));
  justify-content: center;
}
.key {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: calc(48px * var(--scale));
  padding: calc(6px * var(--scale)) calc(12px * var(--scale));
  background: var(--key-bg);
  border: 1px solid var(--border);
  border-radius: calc(10px * var(--scale));
  cursor: pointer;
  font-size: calc(18px * var(--scale));
  flex: 0 0 auto;
  color: var(--ink);
  transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease, transform 0.12s ease;
}
.key mjx-container {
  font-size: calc(20px * var(--scale));
  max-width: 100%;
}
.key:hover,
.key:focus-visible {
  background: color-mix(in srgb, var(--brand) 25%, var(--key-bg));
  border-color: var(--brand);
  box-shadow: 0 calc(4px * var(--scale)) calc(14px * var(--scale)) rgba(37, 99, 235, 0.30);
  transform: translateY(calc(-1px * var(--scale)));
}
.key:active {
  transform: translateY(calc(1px * var(--scale)));
}
.hint { font-size: calc(12px * var(--scale)); color: var(--muted); margin-top: calc(4px * var(--scale)); }
.editor {
  display: grid;
  gap: calc(6px * var(--scale));
}
.editor label {
  display: flex;
  align-items: center;
  gap: calc(8px * var(--scale));
  font-size: calc(13px * var(--scale));
  color: var(--muted);
}
.editor label strong {
  font-weight: 600;
  color: var(--ink);
}
.editor .copyBtn {
  margin-left: auto;
}
.stack {
  display: grid;
  gap: calc(16px * var(--scale));
}
math-field::part(virtual-keyboard-toggle),
math-field::part(menu-toggle),
math-field::part(toolbar) {
  display: none !important;
}

/* === Pretty-up pack (drop-in overrides) === */

/* Font & smoother text rendering */
html, body {
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Subtle gradient background that adapts to theme */
:root {
  --bg-grad-1: radial-gradient(1200px 600px at 10% -10%, rgba(37, 99, 235, 0.10), transparent 60%),
               radial-gradient(900px 500px at 110% 10%, rgba(99, 102, 241, 0.10), transparent 60%);
}
[data-theme="dark"] {
  --bg-grad-1: radial-gradient(1200px 600px at 10% -10%, rgba(37, 99, 235, 0.18), transparent 60%),
               radial-gradient(900px 500px at 110% 10%, rgba(99, 102, 241, 0.18), transparent 60%);
}
body {
  background-image: var(--bg-grad-1), var(--wallpaper);
  background-size: auto, 28px 28px;
  background-attachment: fixed, fixed;
  background-position: center, center;
  background-repeat: no-repeat, repeat;
}

/* Header glow-up */
header {
  background: linear-gradient(135deg, var(--color-header-bg), #3b82f6 55%, #6366f1);
  box-shadow: 0 12px 28px rgba(2, 6, 23, 0.35);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}
header h1 {
  letter-spacing: -0.01em;
  font-size: 20px;
  line-height: 1.2;
  position: relative;
}
header h1::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -6px;
  width: 108px;
  height: 3px;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(255,255,255,0.78), rgba(199,210,254,0.85) 65%, transparent);
  filter: blur(0.25px);
}

/* Panels & cards with glassy feel */
.panel,
.card {
  border-radius: 18px;
  backdrop-filter: saturate(1.08) blur(9px);
  -webkit-backdrop-filter: saturate(1.08) blur(9px);
  background: color-mix(in srgb, var(--color-surface) 86%, transparent);
  border: 1px solid color-mix(in srgb, var(--color-border) 70%, transparent);
  box-shadow: 0 18px 36px rgba(8, 15, 35, 0.18);
  transition: transform 0.18s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
}
.panel:hover,
.card:hover {
  box-shadow: 0 22px 44px rgba(8, 15, 35, 0.22);
  background: color-mix(in srgb, var(--color-surface) 92%, transparent);
  border-color: color-mix(in srgb, var(--color-border) 90%, transparent);
}

/* Input surfaces */
math-field,
textarea {
  box-shadow: 0 1px 0 rgba(2, 6, 23, 0.05);
  background: color-mix(in srgb, var(--color-surface) 95%, transparent);
}
math-field:focus-within,
textarea:focus {
  outline: 2px solid color-mix(in srgb, var(--color-tab-active-bg) 60%, white);
  outline-offset: 2px;
  border-color: color-mix(in srgb, var(--color-tab-active-bg) 65%, var(--border));
}

/* Preview surface */
#preview {
  border-radius: 14px;
  background: color-mix(in srgb, var(--color-surface) 92%, transparent);
  border: 1px solid color-mix(in srgb, var(--color-border) 70%, transparent);
}

/* Copy buttons */
.copyBtn,
.header-copy {
  border-radius: 14px;
  letter-spacing: 0;
  padding: calc(9px * var(--scale)) calc(20px * var(--scale));
  box-shadow: 0 14px 28px rgba(8, 15, 35, 0.22);
  background: color-mix(in srgb, var(--copy-bg) 90%, transparent);
  border-color: color-mix(in srgb, var(--copy-border) 70%, transparent);
}
.copyBtn:hover,
.header-copy:hover {
  box-shadow: 0 18px 32px rgba(8, 15, 35, 0.28);
}

/* Keyboard keys */
.key {
  border-radius: 16px;
  background: color-mix(in srgb, var(--key-bg) 85%, transparent);
  box-shadow: 0 14px 26px rgba(8, 15, 35, 0.2);
}
.key:hover {
  box-shadow: 0 18px 30px rgba(8, 15, 35, 0.24);
}

/* Theme toggle capsule */
.theme-segmented {
  display: inline-flex;
  align-items: center;
  gap: calc(10px * var(--scale));
  padding: calc(6px * var(--scale)) calc(12px * var(--scale));
  border-radius: calc(20px * var(--scale));
  background: rgba(18, 32, 58, 0.88);
  border: 1px solid rgba(103, 126, 176, 0.45);
  box-shadow: 0 16px 34px rgba(8, 15, 35, 0.28);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
}
.theme-segmented[data-active="light"] {
  background: rgba(240, 246, 255, 0.78);
  border-color: rgba(149, 181, 235, 0.55);
  box-shadow: 0 16px 32px rgba(80, 125, 205, 0.22);
}
.theme-segmented[data-active="dark"] {
  background: rgba(17, 27, 52, 0.9);
  border-color: rgba(94, 143, 230, 0.45);
}
.theme-segmented[data-active="system"] {
  background: rgba(24, 36, 68, 0.86);
  border-color: rgba(132, 170, 240, 0.45);
}
.theme-segmented label {
  width: calc(46px * var(--scale));
  height: calc(34px * var(--scale));
  border-radius: calc(12px * var(--scale));
  padding: 0;
  font-size: calc(18px * var(--scale));
  color: rgba(226, 232, 240, 0.85);
  border: 1px solid transparent;
  background: transparent;
  transition: background 0.18s ease, color 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
}
[data-theme="light"] .theme-segmented label { color: rgba(18, 30, 55, 0.82); }
.theme-segmented label:hover {
  background: rgba(255, 255, 255, 0.16);
  color: rgba(248, 250, 252, 0.95);
}
.theme-segmented input:checked + label {
  background: rgba(255, 255, 255, 0.2);
  color: #f8fafc;
  border-color: rgba(255, 255, 255, 0.45);
  box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.38), 0 0 0 1px rgba(255, 255, 255, 0.25);
}
[data-theme="light"] .theme-segmented input:checked + label {
  background: rgba(255, 255, 255, 0.7);
  color: #0f172a;
  border-color: rgba(148, 163, 184, 0.55);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.58), 0 0 0 1px rgba(148, 163, 184, 0.45);
}

/* Theme switcher text styling */
.theme-switcher { color: var(--color-header-text); }

/* Toast feedback */
#toast {
  position: fixed;
  left: 50%;
  bottom: 40px;
  transform: translateX(-50%) translateY(40px);
  background: rgba(34, 197, 94, 0.95);
  color: #fff;
  padding: 10px 18px;
  border-radius: 999px;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.01em;
  box-shadow: 0 12px 28px rgba(2, 6, 23, 0.25);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease, transform 0.25s ease;
  z-index: 9999;
}
#toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

</style>
<script>
  window.MathJax = {
    tex: { inlineMath: [['$', '$'], ['$$', '$$']], macros: { placeholder: '\\square' } },
    svg: { fontCache: 'global' }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>
<link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css">
<link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.css">
</head>
<body>
<header>
  <div class="header-left">
    <h1>HSC Chemistry ‚Äì Equation Typer</h1>
    <div class="header-actions">
      <button type="button" class="header-copy" id="headerCopyLatex">Copy LaTeX</button>
      <button type="button" class="header-copy" id="headerCopyWord">Copy Word Equation</button>
    </div>
  </div>
  <div class="header-controls">
    <div id="status">Loading‚Ä¶</div>
    <label class="theme-switcher">
      <span class="visually-hidden">Theme</span>
      <div class="theme-segmented" role="radiogroup" aria-label="Theme selection">
        <input type="radio" id="themeLight" name="themeSegment" value="light" aria-label="Light">
        <label for="themeLight" title="Light">‚òÄÔ∏è</label>
        <input type="radio" id="themeDark" name="themeSegment" value="dark" aria-label="Dark">
        <label for="themeDark" title="Dark">üåô</label>
        <input type="radio" id="themeSystem" name="themeSegment" value="system" aria-label="System">
        <label for="themeSystem" title="System">üñ•Ô∏è</label>
      </div>
      <select id="themeMode" aria-label="Theme selection" class="visually-hidden">
        <option value="system">System</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </label>
  </div>
</header>
<main>
  <div class="panel">
    <div class="head">Chemistry Keys</div>
    <div class="body" id="keyboard"></div>
  </div>

  <div class="card preview-card">
    <div class="body">
      <div id="preview"></div>
    </div>
  </div>

  <div class="card">
    <div class="body stack">
      <div class="editor">
        <label><strong>Rendered Input (Editable)</strong></label>
        <math-field id="mf" smart-fence letter-shape-style="tex" virtual-keyboard-mode="off" tabindex="0" placeholder="Type here‚Ä¶"></math-field>
      </div>
      <div class="editor">
        <label>
          <strong>Raw LaTeX Input</strong>
          <button id="copyLatex" class="copyBtn" type="button">Copy LaTeX</button>
        </label>
        <textarea id="ta" placeholder="Type or paste LaTeX here‚Ä¶"></textarea>
      </div>
      <div class="editor">
        <label>
          <strong>Word Equation</strong>
          <button id="copyWordBtn" class="copyBtn" type="button">Copy Word Equation</button>
        </label>
        <textarea id="wordOut" placeholder="Word equation output‚Ä¶" readonly></textarea>
      </div>
    </div>
  </div>
</main>

<script>
const THEME_STORAGE_KEY = 'chem-typer-theme';
const themeSelect = document.getElementById('themeMode');
const themeSegment = document.querySelector('.theme-segmented');
const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

const themeStorage = {
  get() {
    try { return localStorage.getItem(THEME_STORAGE_KEY); }
    catch { return null; }
  },
  set(value) {
    try { localStorage.setItem(THEME_STORAGE_KEY, value); }
    catch { /* no-op */ }
  }
};

const resolveTheme = (choice) => choice === 'system'
  ? (prefersDarkScheme.matches ? 'dark' : 'light')
  : choice;

function applyTheme(choice) {
  const resolved = resolveTheme(choice);
  document.documentElement.setAttribute('data-theme', resolved);
  document.documentElement.style.colorScheme = resolved === 'dark' ? 'dark' : 'light';

  if (themeSelect && themeSelect.value !== choice) themeSelect.value = choice;
  if (themeSegment) {
    const target = themeSegment.querySelector(`input[value="${choice}"]`);
    if (target && !target.checked) target.checked = true;
    themeSegment.dataset.active = choice;
  }
}

applyTheme(themeStorage.get() || 'system');

if (themeSelect) {
  themeSelect.addEventListener('change', (event) => {
    const choice = event.target.value;
    applyTheme(choice);
    themeStorage.set(choice);
  });
}

if (themeSegment) {
  themeSegment.addEventListener('change', (event) => {
    const target = event.target;
    if (target && target.name === 'themeSegment') {
      const choice = target.value;
      applyTheme(choice);
      themeStorage.set(choice);
    }
  });
}

const handleSystemThemeChange = () => {
  if ((themeStorage.get() || 'system') === 'system') {
    applyTheme('system');
  }
};

if (typeof prefersDarkScheme.addEventListener === 'function') {
  prefersDarkScheme.addEventListener('change', handleSystemThemeChange);
} else if (typeof prefersDarkScheme.addListener === 'function') {
  prefersDarkScheme.addListener(handleSystemThemeChange);
}

const mathField = document.getElementById('mf');
const textArea = document.getElementById('ta');
const wordOutput = document.getElementById('wordOut');
const previewDiv = document.getElementById('preview');
const statusDiv = document.getElementById('status');

function showToast(message = 'Copied!') {
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.textContent = message;
  toast.classList.add('show');
  clearTimeout(showToast._timeout);
  showToast._timeout = setTimeout(() => toast.classList.remove('show'), 1600);
}

async function copyToClipboard(text, label = 'text') {
  let success = false;
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
      success = true;
    }
  } catch (err) {
    success = false;
  }

  if (!success) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.setAttribute('readonly', '');
    textarea.style.position = 'fixed';
    textarea.style.left = '-9999px';
    document.body.appendChild(textarea);
    textarea.select();
    try {
      success = document.execCommand('copy');
    } catch (err) {
      success = false;
    }
    document.body.removeChild(textarea);
  }

  if (statusDiv) {
    statusDiv.textContent = success ? `Copied ${label} ‚úì` : `Copy ${label} failed`;
  }
  showToast(success ? `Copied ${label} ‚úì` : 'Copy failed');
}

function typesetMath(){ 
  if(window.MathJax) {
    try {
      window.MathJax.typesetPromise([previewDiv]);
    } catch(e) {
      console.warn('MathJax typeset failed', e);
    }
  }
}

function toWordEquation(latex) {
  let w = String(latex ?? '');

  // Arrows
  w = w.replace(/\xrightarrow\s*\{\s*([\s\S]*?)\s*\}/g, (match, rawLabel) => {
    const label = (rawLabel || '').trim();
    if (!label) {
      return '\\longrightarrow';
    }
    const hasPlaceholder = /\\placeholder/.test(label);
    const startsWithCommand = /^\\[A-Za-z]/.test(label);
    if (hasPlaceholder || startsWithCommand) {
      return `\\buildrel${label}\\over\\longrightarrow`;
    }
    return `\\buildrel\\ ${label}\\over\\longrightarrow`;
  });
  w = w.replace(/\\\\buildrel/g, '\\buildrel');
  // Thin spaces become real spaces for Word
  w = w.replace(/\\:/g, ' ');
  // Differential adjustments
  w = w.replace(/\\differentialD\s?/g, 'd');
  w = w.replace(/d\\theta/g, 'd{\\theta}');
  w = w.replace(/d\\mu/g, 'd{\\mu}');
  // Logical implication arrow
  w = w.replace(/\\implies/g, '\Longrightarrow');
  // Absolute value to scalable delimiters
  w = w.replace(/\\lvert([\s\S]*?)\\rvert/g, '\left|$1\right|');
  // Matrix environment for Word equation editor
  w = w.replace(/\\begin\{pmatrix\}([\s\S]*?)\\end\{pmatrix\}/g, (match, inside) => {
    const content = inside.trim().replace(/\\*$/, '') + '\\';
    return '\\left(\\begin{matrix}' + content + '\\end{matrix}\\right)';
  });

  // Isotope conversion ONLY
  // Base X allowed: element symbol [A-Z][a-z]?, or {‚Ä¶}, or \placeholder{‚Ä¶}
  const EL = '(?:[A-Z][a-z]?|\\{[^}]*\\}|\\\\placeholder\\{[^}]*\\})';

  // ^{A}_{Z}X OR ^{A}_Z X  ‚Üí  {_{ {Z} }^{ {A} }}X
  w = w.replace(
    new RegExp('\\^\\{\\s*([^}]*)\\s*\\}_(?:\\{\\s*([^}]*)\\s*\\}|\\s*([^\\s]+))\\s*(' + EL + ')', 'g'),
    (m, A, Z1, Z2, X) => `{_{ {${Z1 || Z2}} }^{ {${A}} }}${X}`
  );

  // _{Z}^{A}X OR _Z^{A}X  ‚Üí  {_{ {Z} }^{ {A} }}X
  w = w.replace(
    new RegExp('_(?:\\{\\s*([^}]*)\\s*\\}|\\s*([^\\s]+))\\s*\\^\\{\\s*([^}]*)\\s*}\\s*(' + EL + ')', 'g'),
    (m, Z1, Z2, A, X) => `{_{ {${Z1 || Z2}} }^{ {${A}} }}${X}`
  );

  // Greek shortcuts ‚Üí Unicode
  w = w.replace(/\\alpha/g, 'Œ±');
  w = w.replace(/\\beta/g, 'Œ≤');
  w = w.replace(/\\gamma/g, 'Œ≥');

  // Placeholders marker
  w = w.replace(/\\placeholder\{[^}]*\}/g, '[placeholder]');

  return w;
}

function syncFromMath(){
  const val = mathField.getValue('latex') || '';
  textArea.value = val;
  wordOutput.value = toWordEquation(val);
  previewDiv.innerHTML = '$$' + val + '$$';
  typesetMath();
}

function syncFromText(){
  const val = textArea.value;
  wordOutput.value = toWordEquation(val);
  previewDiv.innerHTML = '$$' + val + '$$';
  typesetMath();
  mathField.setValue(val);
}

// Fixed regex to match the actual state format: _{(state)}
const stateRegex = /_\{\((?:s|l|g|aq)\)\}$/;

function setupMathField(){
  mathField.setOptions({virtualKeyboardMode:'off',inlineShortcuts:{},overrideDefaultInlineShortcuts:true});
  mathField.addEventListener('input', syncFromMath);
  textArea.addEventListener('input', syncFromText);

  mathField.addEventListener('keydown', (e)=>{
    if(e.key === ' '){ e.preventDefault(); insertText(' \\: '); return; }
    if(e.key !== 'Backspace') return;
    const latex = mathField.getValue('latex') || '';
    if(stateRegex.test(latex)){
      e.preventDefault();
      mathField.setValue(latex.replace(stateRegex, ''));
      syncFromMath();
    }
  });

  textArea.addEventListener('keydown', (e)=>{
    if(e.key !== 'Backspace') return;
    const v = textArea.value || '';
    if(stateRegex.test(v)){
      e.preventDefault();
      const result = v.replace(stateRegex, '');
      textArea.value = result;
      textArea.setSelectionRange(result.length, result.length);
      syncFromText();
    }
  });

  mathField.focus();
  syncFromMath();
}

// Fixed regex to match the actual state format
function stripState(text){
  const match = text.match(/^(.*)_\{\((?:s|l|g|aq)\)\}$/);
  return match ? match[1] : text;
}

function findSpeciesStart(latex, position){
  let i = position - 1;
  while(i >= 0 && /\s/.test(latex[i])) i--;
  let start = i + 1;
  const isBoundary = (ch, prev) => {
    if(!ch) return true;
    if(/[\s+=><]/.test(ch)) return true; // minus is special-cased below
    if(ch === '¬∑' || ch === '\\') return true;
    if(ch === '-' && prev !== '^') return true;
    return false;
  };
  function scanBalanced(close, open){
    let depth = 0, k = i;
    for(; k >= 0; k--){
      const c = latex[k];
      if(c === close) depth++;
      else if(c === open){
        depth--;
        if(depth === 0) break;
      }
    }
    return k;
  }
  while(i >= 0){
    const c = latex[i], prev = latex[i-1];
    if(c === '}'){
      const k = scanBalanced('}', '{');
      if(k < 0) break;
      start = k; i = k - 1;
      if(latex[i] === '^' || latex[i] === '_'){ start = i; i--; continue; }
      continue;
    }
    if(c === ')'){
      const k = scanBalanced(')', '(');
      if(k < 0) break;
      start = k; i = k - 1; continue;
    }
    if(/[a-z]/.test(c)){
      let k = i; while(k >= 0 && /[a-z]/.test(latex[k])) k--;
      if(k >= 0 && /[A-Z]/.test(latex[k])){ start = k; i = k - 1; continue; }
      start = k + 1; i = k; continue;
    }
    if(/[A-Z]/.test(c)){ start = i; i--; continue; }
    if(/[0-9]/.test(c)){
      let k = i; while(k >= 0 && /[0-9]/.test(latex[k])) k--;
      const before = latex[k];
      if(before && /[a-zA-Z)}]/.test(before)){ start = k + 1; i = k; continue; }
      break;
    }
    if(isBoundary(c, prev)) break;
    start = i; i--;
  }
  return Math.max(0, start);
}

function applyStateToText(latex, position, state){
  const left = stripState(latex.slice(0, position));
  const right = latex.slice(position);
  const base = left + right;
  const newPos = left.length;
  const start = findSpeciesStart(base, newPos);
  const species = base.slice(start, newPos);
  const result = base.slice(0, start) + '{' + species + '}_{(' + state + ')}' + base.slice(newPos);
  return { result, position: (base.slice(0, start) + '{' + species + '}_{(' + state + ')}').length };
}

function applyState(state){
  let latex = mathField.getValue('latex') || '';
  const position = latex.length;
  const { result } = applyStateToText(latex, position, state);
  mathField.setValue(result);
  syncFromMath();
}

function insertText(text){ mathField.insert(text); syncFromMath(); }

const chemKeys = [
  { display: '\\rightarrow', insert: ' \\rightarrow ' },
  { display: '\\rightleftharpoons', insert: ' \\rightleftharpoons ' },
  { display: '\\xrightarrow{\\placeholder{}}', insert: ' \\xrightarrow{\\placeholder{}} ' },
  { display: '(s)', action: () => applyState('s') },
  { display: '(l)', action: () => applyState('l') },
  { display: '(g)', action: () => applyState('g') },
  { display: '(aq)', action: () => applyState('aq') },
  { display: '\\xrightarrow{\\Delta}', insert: ' \\xrightarrow{\\Delta} ' },
  { display: '^{\\placeholder{}}_{\\placeholder{}}\\placeholder{}', insert: '^{\\placeholder{}}_{\\placeholder{}}\\placeholder{}' },
  { display: '\\alpha', insert: '\\alpha' },
  { display: '\\beta', insert: '\\beta' },
  { display: '\\gamma', insert: '\\gamma' },
  { display: '\\overline{\\beta}\\:', insert: '\\overline{\\beta}\\:' }
];

function buildKeys(){
  const container = document.getElementById('keyboard');
  container.innerHTML = '';
  chemKeys.forEach(key => {
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'key';
    button.innerHTML = '$$' + key.display + '$$';
    button.addEventListener('click', () => { if(key.action) key.action(); else insertText(key.insert); });
    container.appendChild(button);
  });
  if(window.MathJax) window.MathJax.typesetPromise([container]);
}

(async()=>{
  const urls = ['https://cdn.jsdelivr.net/npm/mathlive/dist/mathlive.min.js','https://unpkg.com/mathlive/dist/mathlive.min.js'];
  let mathLiveLoaded = false;
  
  for(const url of urls){
    try{
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url; 
        script.defer = true; 
        script.onload = () => {
          mathLiveLoaded = true;
          resolve();
        }; 
        script.onerror = reject;
        document.head.appendChild(script);
      });
      break;
    }catch(e){
      console.warn('Failed to load MathLive from', url, e);
    }
  }
  
  // Wait for MathLive to be defined
  if(window.customElements && window.customElements.whenDefined) {
    try {
      await customElements.whenDefined('math-field');
    } catch(e) {
      console.warn('MathLive custom element not defined', e);
    }
  }
  
  // Setup regardless of MathLive status
  setupMathField();
  buildKeys();
  
  if(mathLiveLoaded && window.MathfieldElement) {
    statusDiv.textContent = 'Ready';
  } else {
    statusDiv.textContent = 'Fallback mode - MathLive not available';
  }
})();

document.getElementById('copyLatex').addEventListener('click', () => {
  copyToClipboard(textArea.value, 'LaTeX');
});

document.getElementById('copyWordBtn').addEventListener('click', () => {
  copyToClipboard(wordOutput.value, 'word equation');
});

document.getElementById('headerCopyLatex').addEventListener('click', () => {
  copyToClipboard(textArea.value, 'LaTeX');
});

document.getElementById('headerCopyWord').addEventListener('click', () => {
  copyToClipboard(wordOutput.value, 'word equation');
});
</script>

<div id="toast" role="status" aria-live="polite"></div>
</body>
</html>
